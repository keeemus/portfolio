# 심장은 영원히 뛰지 않습니다.

## 문제점 파악
- 프로축구 중계를 보던 중 대표적인 심장질환인 부정맥으로 인해 쓰러진 후 적절한 처치를 받지 못해 사망하는 사건을 목격함.
팀에 소속되어 모든 부분에서 최고 수준의 관리를 받는 선수들조차 쉽게 극복하지 못하는 질환이라면 일반인에게는 얼마나 치명적인 질환일까 고민하는 과정에서 
’부정맥을 발견하고 위험한 상황임을 사전에 인지시킨다면 사망으로 전환되는 비율을 줄일 수 있을 것이다’ 라는 생각에 진행함.

## 문제점 개선 방향
- 심장질환을 판정받기까지 간단한 설문부터 정밀검사 등 다양한 과정이 있지만 이는 환자 본인이 몸에 이상을 겪은 후에 이루어지는 과정으로 **예방**과는 거리가 멀다. 이 프로젝트는 건강보험에 가입한 대한민국 국민이라면 2년에 1번은 받는 건강검진 데이터를 활용하여 자신이 심혈관 질환에 얼마나 노출되어있는지 확인하고 심혈관 질환 관련 증상을 경험하지 않더라도 개인의 신체상태를 인지하고 개선하여 질환이 발병하는 것을 **예방**하는 데에 있다.

## 프로젝트 진행 과정

### 프로젝트 목표 설정
- 개인 건강검진 데이터 중 심혈관질환 예측인자를 활용하여 심장질환 위험군 분류

### 데이터 수집 및 분석
1. 데이터 수집
    - 국민 건강보험공단에서 매년 제공하는 건강보험 가입자의 검진 공공데이터 활용
    </br>[데이터 다운로드 링크](https://www.data.go.kr/data/15007122/fileData.do)
    - 총 3천 1백만 개의 원본 데이터(1,000,000개의 행 * 31개의 열)
</br>[데이터 상세 설명](https://github.com/keeemus/portfolio/blob/main/1_preprocessing.ipynb)
2. 데이터 정제(전처리 및 레이블링)
    - 데이터 전처리
        1. 예측인자에 사용되지 않는 특성 제거
            - 제거 대상 : 기준년도, 가입자 일련번호, 시도코드, 체중, 시력, 청력, 혈색소, 요단백, 혈청크레아티닌, 혈청지오티, </br>
                        감마지피티, 구강검진 수검여부, 치아우식증유무, 치석, 데이터 공개일자
        2. 연령대 특성 수정(5세 단위 → 실제 연령대)
            - 예시 : 원본표기(10) → 실제연령대(10 * 5)
        3. 예측인자로 활용할 허리신장비율 특성 생성
        4. 결측치 처리
            - 지질 관련 특성(총 콜레스테롤, 중성지방, HDL/LDL 콜레스테롤)의 결측치가 60% 이상으로 매우 많음</br>
              절반이 넘는 결측치를 어떤 특정한 값으로 단순히 채우기만 한다면 데이터 분포에 큰 영향을 미치므로 아래 2가지 방법 적용 후 성능비교</br> 
                 ```1. 머신러닝 모델을 활용하여 결측치 대체```([scikit-learn의 iterative imputer](https://scikit-learn.org/stable/modules/impute.html#iterative-imputer))</br>
                 ```2. 결측치 특성 전체 제거```</br>
        5. 타겟 데이터 생성
            - 각 특성별 기준에 부합하는 만큼 점수 부여 → '최종점수' 특성 생성
                - 0점을 기준으로 양성요인에 해당할 경우 +1점, 음성요인에 해당할 경우 -1점 부여</br>
                    ```
                    양성요인 : 연령, 흡연, 음주여부, 비만, 고혈압, 이상지질혈증, 당뇨
                    음성요인 : 고밀도 지단백 콜레스테롤(HDL 콜레스테롤)
                    ```
                - 음성요인 컬럼은 결측치 대체한 데이터셋만 적용
                - 점수 기준</br>
                    `기준에 해당할 경우 0점부터 컬럼에 기재되어있는 점수 누적합산`
                <figure><img src="/arrhythmia_prevention/image/score_criteria.png" width="500" height="600"></figure>
            - ‘최종점수’ 컬럼에 부여된 점수에 따라 ‘위험군' 컬럼에 정상 ~ 극위험군에 해당되는 정수 매핑
                ```
                정상 : 0점
                저위험 : 1점
                중등도 : 2점
                고위험 : 3점
                극위험 : 4점
                ```
            - 최종 생성된 ‘위험군’ 특성을 타겟 데이터로 설정하여 모델링 진행
3. EDA 및 결과
    - 데이터셋 2가지 따로 진행
    - 타겟 분포 확인
    <figure><img src="/arrhythmia_prevention/image/original/target_ratio.png" width="350" height="350">
            <img src="/arrhythmia_prevention/image/drop/target_ratio_drop.png" width="350" height="350"></figure>
           
            1. 클래스별 타겟데이터가 불균형함
            2. 전체 위험군 중 정상과 저위험군이 약 90%, 80%를 차지함
            
    - 각 위험군별 양성요인 평균치 확인
    <figure><img src="/arrhythmia_prevention/image/original/feature_mean.png" width="300" height="300">
            <img src="/arrhythmia_prevention/image/drop/feature_mean_drop.png" width="300" height="300"></figure>
    
    - 각 위험군별 허리신장비율 확인
    <figure><img src="/arrhythmia_prevention/image/original/waist_to_height_ratio.png" width="300" height="300">
            <img src="/arrhythmia_prevention/image/drop/waist_to_height_ratio_drop.png" width="300" height="300"></figure>
    
    - 각 위험군별 연령대 평균치 확인
    <figure><img src="/arrhythmia_prevention/image/original/age.png" width="300" height="300">
            <img src="/arrhythmia_prevention/image/drop/age_drop.png" width="300" height="300"></figure>
                
                1. 고위험군에 속할수록 양성요인과 허리신장비율이 증가함
                2. 중등도 이상의 비율이 약 10%, 20%인 것과 평균 연령대가 59.6세이고 고위험군에 속할수록 연령대가 높아지는 것을 감안했을 때
                   심혈관 질환 위험을 사전에 인지하고 생활습관, 식습관을 개선한다면 긍정적인 결과가 예상됨
    
    - 결측치 대체한 데이터셋의 경우 중성지방, LDL 콜레스테롤, 음주여부 특성에서 최소값이 음수인 경우 발생</br>
      -> 음수가 나올 수 없는 특성이기 때문에 이상치 제거시 같이 제거함
    - 실제 측정된 기록된 개인의 건강 데이터를 기반으로 위험군을 분류해야하기때문에 이상치 설정시 최대값은 각 특성별 임상에서 실제로 측정될 수 있는 최대치로 설정
    - 결측치 대체한 데이터셋을 활용하여 학습한 모델이 결측치를 제거한 데이터셋 대비 각 클래스별 불균형도가 적기때문에 전반적으로 좋은 성능을 낼 것이라 예상됨

4. 데이터 모델링
    - 5개의 클래스(정상, 저위험군, 중등도 위험군, 고위험군, 극위험군)를 다중분류하기위해 신경망 모델과 트리기반 앙상블 모델 활용
    - 결측치 대체 데이터셋과 결측치 제거 데이터셋을 모델링 후 각각 비교하여 성능이 좋은 모델 및 데이터셋 선택 
    - 타겟 데이터가 불균형하므로 정확한 분류를 위해 평가지표로 조화평균(macro avg f1-score)을 채택하여 성능평가 진행
    - 모델링 결과
        - 결측치 제거 모델
            <figure><img src="/arrhythmia_prevention/image/drop/model_score_drop.png" width="900" height="300"></figure>
            
            1. 모든 모델의 튜닝은 과적합을 개선하는 것에 초점을 두고 진행
            2. 랜덤포레스트 기본 모델이 좋은 성능을 기록했지만 과적합이 발생했고 튜닝을 진행하면서 모든 클래스에서 성능이 떨어짐
            3. 전체적으로 데이터가 확보된 클래스에 대해서는 좋은 성능을 기록하지만 데이터가 부족한 고위험군, 극위험군에 대해서는 성능이 떨어짐
            4. 특히 튜닝 후 극위험군에 대한 성능이 LGBM 모델을 제외한 모든 모델에서 성능저하 발생, LGBM 모델은 성능이 향상됐지만 전체 성능 확보에 문제가 있음
            
        - 결측치 대체 모델
            <figure><img src="/arrhythmia_prevention/image/original/model_score.png" width="900" height="300"></figure>
            
            1. 데이터가 어느정도 확보된 상태라 고위험군, 극위험군의 분류성능이 결측치 제거 모델과 비슷하거나 좋은 성능을 보임
            2. 역시 랜덤포레스트 모델과 LGBM 모델에서 과적합 발생
            3. 과적합 개선을 위한 튜닝 후 성능 재측정 -> XGBoost 모델 제외 모든 모델에서 성능저하 발생
            4. XGBoost 모델은 모든 클래스에서 안정적인 성능(92%)을 확보함

    - 튜닝을 거쳐 모든 클래스에 안정적인 성능을 내는 모델인 XGBoost 결측치 대체 모델을 최종모델로 선택
    - XGBoost 최종모델 특성중요도 확인 
            <figure><img src="/arrhythmia_prevention/image/feature_importance.png" width="400" height="500"></figure>
            <figure><img src="/arrhythmia_prevention/image/permutation_importance.png" width="300" height="300"></figure>
            
        1. 특성 중요도와 permutation importacne를 살펴봤을 때 허리신장비율, 식전혈당(공복혈당), 중성지방 세가지 특성이 위험군을 분류하는 데에 중요한 특성이 됨
        2. 실제 임상에서 간단한 예측을 할 때 허리신장비율 특성을 활발하게 활용하는 것을 생각하면 신뢰도가 있는 결과

## 결론
일상에서 쉽게 측정할 수 있는 특성을 활용하여 본인의 건강상태를 체크하고 이를 활용하여 생활습관과 식습관을 개선한다면 현재보다 심각한 질환으로 전이되는 것을 예방할 수 있을 것이라 생각합니다.
특히 연령대가 높아질수록 고위험군에 속하는 것을 봤을 때 조금이라도 일찍 자신의 객관적인 상태를 파악하고 꾸준히 개선한다면 심혈관질환 뿐 아니라 노화에 따른 노인성 질환도 함께 극복할 수 있을 것입니다.
하지만 실제 개인이 자신의 건강상태를 쉽게 파악할 수 있는 방법이 매우 적으며 건강검진을 받더라도 어떤 항목이 어떤 의미를 가지는지 알지 못하고 방치하는 경우가 많습니다.
이에 따라 다음과 같은 방법을 제시합니다.

1. 2년에 1번 뿐인 자신의 상태를 파악할 수 있는 기회를 좀 더 빈번히 가질 수 있도록 건강검진 데이터를 입력받아 ‘심혈관 질환 위험군 예측’ 앱을 개발하여 서비스
2. 단순히 예측 결과만을 보여주는 게 아닌 예측 결과에 따라 생활습관과 식습관을 어떻게 개선해야하는지 솔루션을 함께 제시(운동법, 식단)
3. 습관을 형성하는 데 있어서 가장 중요한 건 관심도이므로 운동에 관한 설문을 미리 실시한 후 반영하여 솔루션 제시
4. 초기 입력기록과 현재 상태를 비교하여 변화 정도를 앱에 노출시켜 꾸준한 관심과 동기부여를 이끌어냄

사회가 발전하고 성장하기 위해서는 공중보건, 기초보건이 제대로 자리잡혀야 한다고 합니다. 시간이 지날수록 노인 인구가 많아지고 경제인구도 고령화가 될텐데 위와 같은 방법으로 질환 발병 전에 경각심을 유지시키고 습관을 개선한다면 개인의 건강 뿐 아니라 다른 분야에서도 선순환이 일어날 것이라 확신합니다.

## 힌계점 및 보완 사항
1. 이상치 설정할 때 기존 임상에서 활발하게 활용되는 기준으로 정하긴 했지만 더 정확한 분류를 하기위해서는 각 분야의 전문가와 함께 소통하며 설정해야하는데 개인 프로젝트이다보니 임상기준에 의존함
2. 실제로 분류가 정확하게 되는지 확인이 불가능하여 성능지표에 의존함
3. 앱 개발 혹은 웹서비스 개발에 대한 지식, 이해도가 없어 실제로 서비스를 만들어보지 못함 -> 추후에 추가로 공부하여 파이썬 플라스크와 같은 간단한 웹서비스 개발 시도
4. 결측치 처리 기법에 대한 이해도가 부족하여 하나의 방법만 적용하고 여러 시도를 해보지 못함 -> 다양한 결측치 처리기법 이해한 후 새로운 결측치 대체 데이터셋으로 모델링 시도
